name: Android CI/CD to Play Store

env:
  # The name of the main module repository
    main_project_module: app

        # The name on Play Store
          playstore_name: CallGuardian

          on:
            push:
                branches:
                      - master
                          tags:
                                - 'v*'
                                  pull_request:
                                      branches:
                                            - master
                                              # Allows manual trigger from Actions tab
                                                workflow_dispatch:

                                                jobs:
                                                  build:
                                                      name: Build & Test
                                                          runs-on: ubuntu-latest

                                                                  steps:
                                                                        - uses: actions/checkout@v4

                                                                                    # Set Current Date As Env Variable
                                                                                          - name: Set current date as env variable
                                                                                                  run: echo "date_today=$(date +'%Y-%m-%d')" >> $GITHUB_ENV
                                                                                                        
                                                                                                              # Set Repository Name As Env Variable  
                                                                                                                    - name: Set repository name as env variable
                                                                                                                            run: echo "repository_name=$(echo '${{ github.repository }}' | awk -F '/' '{print $2}')" >> $GITHUB_ENV
                                                                                                                                  
                                                                                                                                        - name: Set Up JDK
                                                                                                                                                uses: actions/setup-java@v4
                                                                                                                                                        with:
                                                                                                                                                                  distribution: 'zulu'
                                                                                                                                                                            java-version: '17'
                                                                                                                                                                                      cache: 'gradle'
                                                                                                                                                                                            
                                                                                                                                                                                                  - name: Change wrapper permissions
                                                                                                                                                                                                          run: chmod +x ./gradlew
                                                                                                                                                                                                                
                                                                                                                                                                                                                      # Run Tests
                                                                                                                                                                                                                            - name: Run gradle tests
                                                                                                                                                                                                                                    run: ./gradlew test
                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                # Run Lint
                                                                                                                                                                                                                                                      - name: Run Lint
                                                                                                                                                                                                                                                              run: ./gradlew lintDebug
                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                          # Build Project
                                                                                                                                                                                                                                                                                - name: Build gradle project
                                                                                                                                                                                                                                                                                        run: ./gradlew build
                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                    # Create APK Debug
                                                                                                                                                                                                                                                                                                          - name: Build apk debug project (APK)
                                                                                                                                                                                                                                                                                                                  run: ./gradlew assembleDebug
                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                              # Create APK Release
                                                                                                                                                                                                                                                                                                                                    - name: Build apk release project (APK)
                                                                                                                                                                                                                                                                                                                                            run: ./gradlew assemble
                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                        # Create Bundle AAB Release
                                                                                                                                                                                                                                                                                                                                                              - name: Build app bundle release (AAB)
                                                                                                                                                                                                                                                                                                                                                                      run: ./gradlew ${{ env.main_project_module }}:bundleRelease
                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                  # Upload Debug APK Artifact
                                                                                                                                                                                                                                                                                                                                                                                        - name: Upload APK Debug
                                                                                                                                                                                                                                                                                                                                                                                                uses: actions/upload-artifact@v4
                                                                                                                                                                                                                                                                                                                                                                                                        with:
                                                                                                                                                                                                                                                                                                                                                                                                                  name: ${{ env.date_today }} - ${{ env.playstore_name }} - ${{ env.repository_name }} - APK(s) debug generated
                                                                                                                                                                                                                                                                                                                                                                                                                            path: ${{ env.main_project_module }}/build/outputs/apk/debug/
                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                        # Upload Release APK Artifact
                                                                                                                                                                                                                                                                                                                                                                                                                                              - name: Upload APK Release
                                                                                                                                                                                                                                                                                                                                                                                                                                                      uses: actions/upload-artifact@v4
                                                                                                                                                                                                                                                                                                                                                                                                                                                              with:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        name: ${{ env.date_today }} - ${{ env.playstore_name }} - ${{ env.repository_name }} - APK(s) release generated
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  path: ${{ env.main_project_module }}/build/outputs/apk/release/
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              # Upload AAB Release Artifact
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    - name: Upload AAB (App Bundle) Release
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            uses: actions/upload-artifact@v4
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    with:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              name: ${{ env.date_today }} - ${{ env.playstore_name }} - ${{ env.repository_name }} - App bundle(s) AAB release generated
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        path: ${{ env.main_project_module }}/build/outputs/bundle/release/
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          release:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              name: Release to Play Store
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  needs: build
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      if: startsWith(github.ref, 'refs/tags/')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          runs-on: ubuntu-latest
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  steps:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        - uses: actions/checkout@v4
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    - name: Set Up JDK
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            uses: actions/setup-java@v4
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    with:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              distribution: 'zulu'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        java-version: '17'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  cache: 'gradle'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              - name: Change wrapper permissions
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      run: chmod +x ./gradlew
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  - name: Decode Keystore
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          env:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            run: |
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      echo $KEYSTORE_BASE64 | base64 --decode > app/keystore.jks
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  - name: Build Release AAB
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          env:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    SIGNING_KEY_ALIAS: ${{ secrets.SIGNING_KEY_ALIAS }}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              SIGNING_KEY_PASSWORD: ${{ secrets.SIGNING_KEY_PASSWORD }}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        SIGNING_STORE_PASSWORD: ${{ secrets.SIGNING_STORE_PASSWORD }}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                run: ./gradlew bundleRelease
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            - name: Upload Release AAB
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    uses: actions/upload-artifact@v4
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            with:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      name: release-aab
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                path: app/build/outputs/bundle/release/app-release.aab
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            - name: Create Service Account JSON
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    env:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              GOOGLE_PLAY_SERVICE_ACCOUNT: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT }}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      run: echo $GOOGLE_PLAY_SERVICE_ACCOUNT > service-account.json
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  - name: Upload to Play Store
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          uses: r0adkll/upload-google-play@v1
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  with:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            serviceAccountJson: service-account.json
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      packageName: com.example.callguardian
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                releaseFiles: app/build/outputs/bundle/release/app-release.aab
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          track: internal
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    status: draft
